<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd"
                   logicalFilePath="changelog-base.xml">

    <changeSet author="kokorin" id="0" runAlways="true">
        <preConditions onFail="HALT" onFailMessage="SET CHARSET TO utf8mb4">
            <dbms type="mariadb,mysql"/>
            <sqlCheck expectedResult="0"><![CDATA[
                SELECT COUNT(1) FROM INFORMATION_SCHEMA.SYSTEM_VARIABLES
                WHERE VARIABLE_NAME IN (
                    'CHARACTER_SET_RESULTS',
                    'CHARACTER_SET_CLIENT',
                    'CHARACTER_SET_CONNECTION',
                    'CHARACTER_SET_SERVER',
                    '### excluded from check ### CHARACTER_SET_SYSTEM',
                    'CHARACTER_SET_DATABASE'
                ) AND (
                    ( SESSION_VALUE <> 'utf8mb4' AND SESSION_VALUE IS NOT NULL )
                    OR GLOBAL_VALUE <> 'utf8mb4'
                )
         ]]></sqlCheck>
        </preConditions>
    </changeSet>

    <changeSet id="create-user" author="kokorin">
        <createTable tableName="dmo_user">
            <column name="email" type="VARCHAR(64)">
                <constraints primaryKey="true"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="kokorin" id="create-anime-type-enum">
        <createTable tableName="anime_type_enum">
            <column name="type" type="VARCHAR(32)">
                <constraints primaryKey="true"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="kokorin" id="fill-anime-type-enum">
        <insert tableName="anime_type_enum">
            <column name="type" value="MOVIE"/>
        </insert>
        <insert tableName="anime_type_enum">
            <column name="type" value="SERIES"/>
        </insert>
        <insert tableName="anime_type_enum">
            <column name="type" value="MUSIC"/>
        </insert>
        <insert tableName="anime_type_enum">
            <column name="type" value="UNKNOWN"/>
        </insert>
        <insert tableName="anime_type_enum">
            <column name="type" value="DELETED"/>
        </insert>
    </changeSet>


    <changeSet author="kokorin" id="create-external-system-enum">
        <createTable tableName="external_system_enum">
            <column name="external_system" type="VARCHAR(32)">
                <constraints primaryKey="true"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="kokorin" id="fill-external-system">
        <insert tableName="external_system_enum">
            <column name="external_system" value="ANIDB"/>
        </insert>
    </changeSet>

    <changeSet author="kokorin" id="create-anime">
        <createTable tableName="anime">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="external_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="external_system" type="VARCHAR(32)">
                <constraints nullable="false"
                             foreignKeyName="fk_anime_to_external_system_enum"
                             referencedTableName="external_system_enum"
                             referencedColumnNames="external_system"/>
            </column>
            <column name="type" type="VARCHAR(32)">
                <constraints nullable="false"
                             foreignKeyName="fk_anime_to_anime_type_enum"
                             referencedTableName="anime_type_enum"
                             referencedColumnNames="type"/>
            </column>
            <column name="episode_count" type="BIGINT"/>
            <column name="start_date" type="DATE"/>
            <column name="end_date" type="DATE"/>
            <column name="last_update" type="DATETIME"/>
        </createTable>
    </changeSet>

    <changeSet author="kokorin" id="create-unique-external-constraint">
        <addUniqueConstraint
                columnNames="external_id, external_system"
                constraintName="unique_external_constraint"
                tableName="anime"/>
    </changeSet>

    <changeSet author="kokorin" id="create-anime-title-type-enum">
        <createTable tableName="anime_title_type_enum">
            <column name="type" type="VARCHAR(32)">
                <constraints primaryKey="true"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="kokorin" id="fill-anime-title-type-enum">
        <insert tableName="anime_title_type_enum">
            <column name="type" value="SHORT"/>
        </insert>
        <insert tableName="anime_title_type_enum">
            <column name="type" value="OFFICIAL"/>
        </insert>
    </changeSet>

    <changeSet author="kokorin" id="create-anime-title">
        <createTable tableName="anime_title">
            <column name="anime_id" type="BIGINT">
                <constraints nullable="false"
                             foreignKeyName="fk_anime_title_to_anime"
                             referencedTableName="anime"
                             referencedColumnNames="id"/>
            </column>
            <column name="type" type="VARCHAR(32)">
                <constraints nullable="false"
                             foreignKeyName="fk_anime_title_to_anime_title_type_enum"
                             referencedTableName="anime_title_type_enum"
                             referencedColumnNames="type"/>
            </column>
            <column name="lang" type="VARCHAR(32)">
                <constraints nullable="false"/>
            </column>
            <column name="text" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="kokorin" id="create-anime-title-index" dbms="mariadb,mysql">
        <sql>CREATE
        FULLTEXT INDEX idx_anime_title ON anime_title(text)</sql>
    </changeSet>

    <changeSet author="kokorin" id="create-episode">
        <createTable tableName="episode">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="anime_id" type="BIGINT">
                <constraints nullable="false"
                             foreignKeyName="fk_episode_to_anime"
                             referencedTableName="anime"
                             referencedColumnNames="id"/>
            </column>
            <column name="external_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="number" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="length" type="BIGINT"/>
            <column name="air_date" type="DATE"/>
        </createTable>
    </changeSet>

    <changeSet author="kokorin" id="create-episode-title">
        <createTable tableName="episode_title">
            <column name="episode_id" type="BIGINT">
                <constraints nullable="false"
                             foreignKeyName="fk_episode_title_to_episode"
                             referencedTableName="episode"
                             referencedColumnNames="id"/>
            </column>
            <column name="lang" type="VARCHAR(32)">
                <constraints nullable="false"/>
            </column>
            <column name="text" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
</databaseChangeLog> 